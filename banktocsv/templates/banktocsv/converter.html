{% extends 'banktocsv/base.html' %}

{% block title %}Convertisseur - BankToCSV{% endblock %}

{% block extra_css %}
<style>
    /* Container du formulaire minimaliste */
    .upload-form-container {
        max-width: 500px;
        margin: 0 auto;
    }
    
    /* Zone de drop minimaliste */
    .upload-zone-minimal {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 2rem 1.5rem;
        text-align: center;
        background: #ffffff;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
    }
    
    .upload-zone-minimal:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
    }
    
    .upload-zone-minimal.dragover {
        border-color: #28a745;
        background: #f8fff8;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);
    }
    
    .upload-content-minimal {
        position: relative;
        z-index: 2;
    }
    
    .upload-icon-minimal {
        margin-bottom: 1rem;
    }
    
    .upload-icon-minimal i {
        font-size: 2.5rem;
        color: #6c757d;
        transition: all 0.2s ease;
    }
    
    .upload-zone-minimal:hover .upload-icon-minimal i {
        color: #007bff;
    }
    
    .upload-zone-minimal.dragover .upload-icon-minimal i {
        color: #28a745;
    }
    
    .upload-text-minimal h6 {
        color: #333;
        margin-bottom: 0.5rem;
        font-weight: 500;
        font-size: 1rem;
    }
    
    .upload-text-minimal p {
        color: #666;
        margin: 0.5rem 0;
        font-size: 0.9rem;
    }
    
    /* Bouton d'upload minimaliste */
    .btn-upload-minimal {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0.75rem 1.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin: 1rem 0;
    }
    
    .btn-upload-minimal:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
    }
    
    .btn-upload-minimal:active {
        transform: translateY(0);
    }
    
    .upload-info-minimal {
        margin-top: 1rem;
    }
    
    .upload-info-minimal small {
        color: #888;
        font-size: 0.8rem;
    }
    
    /* Zone de fichier sélectionné minimaliste */
    .file-selected-minimal {
        animation: slideIn 0.3s ease-out;
        margin-top: 1rem;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .file-preview-minimal {
        display: flex;
        align-items: center;
        padding: 1rem;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        gap: 1rem;
    }
    
    .file-icon-minimal {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        background: #dc3545;
        border-radius: 6px;
        color: white;
        font-size: 1.2rem;
    }
    
    .file-details-minimal {
        flex: 1;
    }
    
    .file-name-minimal {
        font-weight: 500;
        color: #333;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .file-size-minimal {
        color: #666;
        font-size: 0.8rem;
    }
    
    .btn-remove-minimal {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.8rem;
    }
    
    .btn-remove-minimal:hover {
        background: #c82333;
        transform: scale(1.1);
    }
    
    /* Styles importants pour forcer l'application */
    .upload-zone-minimal {
        border: 1px solid #e0e0e0 !important;
        border-radius: 8px !important;
        padding: 2rem 1.5rem !important;
        text-align: center !important;
        background: #ffffff !important;
        transition: all 0.2s ease !important;
        cursor: pointer !important;
        position: relative !important;
    }
    
    .btn-upload-minimal {
        background: #007bff !important;
        color: white !important;
        border: none !important;
        border-radius: 6px !important;
        padding: 0.75rem 1.5rem !important;
        font-size: 0.9rem !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 0.5rem !important;
        margin: 1rem 0 !important;
    }
    
    /* Styles pour le bouton de conversion principal */
    .btn-primary {
        background: #007bff;
        border: none;
        border-radius: 8px;
        padding: 1rem 2rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
    }
    
    /* Animation pour les sections */
    .processing-section, .results-section, .error-section {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Spinner personnalisé */
    .spinner-border {
        width: 2.5rem;
        height: 2.5rem;
        border-width: 0.25em;
    }
    
    /* Amélioration du tableau */
    .table {
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid #e9ecef;
    }
    
    .table thead th {
        background: #f8f9fa;
        border: none;
        font-weight: 600;
        color: #495057;
        padding: 1rem 0.75rem;
    }
    
    .table tbody tr {
        transition: all 0.2s ease;
    }
    
    .table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="jumbotron bg-primary text-white rounded p-5 mb-4">
            <h1 class="display-4">
                <i class="bi bi-bank"></i> BankToCSV
            </h1>
            <p class="lead">
                Convertissez vos relevés bancaires Attijari en CSV ou Excel en quelques clics
            </p>
        </div>
    </div>
</div>

<!-- Zone d'upload -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-upload"></i> Convertisseur de relevé bancaire
                </h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Formulaire minimaliste -->
                    <div class="upload-form-container">
                        <!-- Zone de drop minimaliste -->
                        <div class="upload-zone-minimal" id="uploadZone">
                            <div class="upload-content-minimal">
                                <div class="upload-icon-minimal">
                                    <i class="bi bi-cloud-upload"></i>
                                </div>
                                <div class="upload-text-minimal">
                                    <h6>Glissez-déposez votre PDF</h6>
                                    <p>ou</p>
                                </div>
                                <button type="button" class="btn-upload-minimal" id="uploadBtnTrigger">
                                    <i class="bi bi-plus-circle"></i>
                                    Choisir un fichier
                                </button>
                                <div class="upload-info-minimal">
                                    <small>PDF uniquement • Max 10MB</small>
                                </div>
                            </div>
                            <input type="file" class="d-none" id="pdfFile" name="pdf_file" 
                                   accept=".pdf" required>
                        </div>
                        
                        <!-- Zone de fichier sélectionné minimaliste -->
                        <div class="file-selected-minimal d-none" id="fileSelected">
                            <div class="file-preview-minimal">
                                <div class="file-icon-minimal">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </div>
                                <div class="file-details-minimal">
                                    <div class="file-name-minimal" id="fileName">Nom du fichier</div>
                                    <div class="file-size-minimal" id="fileSize">Taille du fichier</div>
                                </div>
                                <button type="button" class="btn-remove-minimal" id="removeFile">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn">
                            <i class="bi bi-arrow-repeat"></i> Convertir en CSV/Excel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Zone de traitement -->
<div class="row mb-4 processing-section" id="processingSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Traitement en cours...</span>
                </div>
                <h5 class="text-primary">Traitement en cours...</h5>
                <p class="text-muted">Extraction des transactions de votre relevé bancaire</p>
            </div>
        </div>
    </div>
</div>

<!-- Zone de résultats -->
<div class="row mb-4 results-section" id="resultsSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle text-success"></i> Relevé traité avec succès
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-success" id="downloadCsvBtn">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Télécharger CSV
                    </button>
                    <button type="button" class="btn btn-info" id="downloadExcelBtn">
                        <i class="bi bi-file-excel"></i> Télécharger Excel
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="newFileBtn">
                        <i class="bi bi-plus-circle"></i> Nouveau fichier
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Nombre de transactions :</strong><br>
                        <span id="resultTransactionCount" class="badge bg-primary"></span>
                    </div>
                    <div class="col-md-4">
                        <strong>Solde final :</strong><br>
                        <span id="resultFinalBalance" class="text-success"></span>
                    </div>
                    <div class="col-md-4">
                        <strong>Date de traitement :</strong><br>
                        <span id="resultProcessedAt" class="text-muted"></span>
                    </div>
                </div>
                
                <!-- Aperçu des transactions -->
                <div class="table-responsive">
                    <table class="table table-hover" id="transactionsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Date Opération</th>
                                <th>Date Valeur</th>
                                <th>Libellé</th>
                                <th class="text-end">Débit</th>
                                <th class="text-end">Crédit</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Zone d'erreur -->
<div class="row mb-4 error-section" id="errorSection" style="display: none;">
    <div class="col-12">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-triangle"></i> Erreur de traitement
                </h5>
            </div>
            <div class="card-body">
                <p id="errorMessage" class="text-danger mb-0"></p>
            </div>
        </div>
    </div>
</div>


<!-- Instructions -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i> Comment utiliser BankToCSV
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="bi bi-upload text-primary" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">1. Upload</h6>
                            <p class="text-muted small">
                                Sélectionnez votre relevé bancaire PDF Attijari
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="bi bi-gear text-warning" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">2. Traitement</h6>
                            <p class="text-muted small">
                                Notre système extrait automatiquement les transactions
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="bi bi-download text-success" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">3. Export</h6>
                            <p class="text-muted small">
                                Téléchargez vos données en CSV ou Excel
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const processingSection = document.getElementById('processingSection');
    const resultsSection = document.getElementById('resultsSection');
    const errorSection = document.getElementById('errorSection');
    const downloadCsvBtn = document.getElementById('downloadCsvBtn');
    const downloadExcelBtn = document.getElementById('downloadExcelBtn');
    const newFileBtn = document.getElementById('newFileBtn');
    
    let currentTransactionsData = null;
    
    // Gestion de l'upload
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(uploadForm);
        
        // Afficher la section de traitement
        hideAllSections();
        processingSection.style.display = 'block';
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Traitement en cours...';
        
        // Envoyer la requête AJAX
        fetch('{% url "banktocsv:process_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher les résultats
                displayResults(data);
            } else {
                // Afficher l'erreur
                displayError(data.message);
            }
        })
        .catch(error => {
            displayError('Erreur de connexion: ' + error.message);
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Convertir en CSV/Excel';
        });
    });
    
    // Gestion des téléchargements
    downloadCsvBtn.addEventListener('click', function() {
        if (currentTransactionsData) {
            downloadFile('csv');
        }
    });
    
    downloadExcelBtn.addEventListener('click', function() {
        if (currentTransactionsData) {
            downloadFile('excel');
        }
    });
    
    // Gestion du bouton nouveau fichier
    newFileBtn.addEventListener('click', function() {
        resetUploadInterface();
        hideAllSections();
    });
    
    // Fonction de téléchargement
    function downloadFile(format) {
        const formData = new FormData();
        formData.append('transactions_data', JSON.stringify(currentTransactionsData));
        formData.append('format_type', format);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        fetch('{% url "banktocsv:download_direct" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                return response.blob();
            }
            throw new Error('Erreur lors du téléchargement');
        })
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `releve_attijari_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.${format === 'csv' ? 'csv' : 'xlsx'}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        })
        .catch(error => {
            alert('Erreur lors du téléchargement: ' + error.message);
        });
    }
    
    // Fonctions utilitaires
    function hideAllSections() {
        processingSection.style.display = 'none';
        resultsSection.style.display = 'none';
        errorSection.style.display = 'none';
    }
    
    function displayResults(data) {
        hideAllSections();
        resultsSection.style.display = 'block';
        
        // Mettre à jour les informations du relevé
        document.getElementById('resultTransactionCount').textContent = data.data.total_transactions;
        document.getElementById('resultProcessedAt').textContent = new Date().toLocaleString('fr-FR');
        
        // Mettre à jour le solde final
        const balanceElement = document.getElementById('resultFinalBalance');
        if (data.data.final_balance !== null) {
            const balance = parseFloat(data.data.final_balance);
            balanceElement.textContent = balance.toFixed(2) + ' TND';
            balanceElement.className = balance >= 0 ? 'text-success' : 'text-danger';
        } else {
            balanceElement.textContent = 'Non disponible';
            balanceElement.className = 'text-muted';
        }
        
        // Mettre à jour le tableau des transactions
        const tableBody = document.getElementById('transactionsTableBody');
        tableBody.innerHTML = '';
        
        data.data.transactions.forEach(transaction => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><span class="badge bg-light text-dark">${transaction.date_operation}</span></td>
                <td><span class="badge bg-light text-dark">${transaction.date_valeur}</span></td>
                <td><span class="text-truncate d-inline-block" style="max-width: 300px;" title="${transaction.libelle}">${transaction.libelle}</span></td>
                <td class="text-end">${transaction.debit > 0 ? '<span class="text-danger">-' + transaction.debit.toFixed(2) + ' TND</span>' : '<span class="text-muted">-</span>'}</td>
                <td class="text-end">${transaction.credit > 0 ? '<span class="text-success">+' + transaction.credit.toFixed(2) + ' TND</span>' : '<span class="text-muted">-</span>'}</td>
            `;
            tableBody.appendChild(row);
        });
        
        // Sauvegarder les données des transactions pour les téléchargements
        currentTransactionsData = data.data.transactions;
    }
    
    function displayError(message) {
        hideAllSections();
        errorSection.style.display = 'block';
        document.getElementById('errorMessage').textContent = message;
    }
    
    function resetUploadInterface() {
        // Réinitialiser l'interface d'upload
        fileInput.value = '';
        uploadZone.style.display = 'block';
        fileSelected.classList.add('d-none');
        currentTransactionsData = null;
    }
    
    // Gestion de l'interface drag & drop minimaliste
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('pdfFile');
    const fileSelected = document.getElementById('fileSelected');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFileBtn = document.getElementById('removeFile');
    const uploadBtnTrigger = document.getElementById('uploadBtnTrigger');
    
    // Clic sur le bouton d'upload
    uploadBtnTrigger.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.click();
    });
    
    // Clic sur la zone d'upload (sauf sur le bouton)
    uploadZone.addEventListener('click', function(e) {
        if (e.target !== uploadBtnTrigger && !uploadBtnTrigger.contains(e.target)) {
            fileInput.click();
        }
    });
    
    // Gestion du drag & drop
    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });
    
    // Gestion de la sélection de fichier
    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            handleFileSelection(this.files[0]);
        }
    });
    
    // Gestion de la suppression de fichier
    removeFileBtn.addEventListener('click', function() {
        fileInput.value = '';
        uploadZone.style.display = 'block';
        fileSelected.classList.add('d-none');
    });
    
    // Fonction pour gérer la sélection de fichier
    function handleFileSelection(file) {
        // Vérifier le type de fichier
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            alert('Veuillez sélectionner un fichier PDF');
            return;
        }
        
        // Vérifier la taille du fichier
        if (file.size > 10 * 1024 * 1024) {
            alert('Fichier trop volumineux (max 10MB)');
            return;
        }
        
        // Afficher les informations du fichier
        fileName.textContent = file.name;
        fileSize.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
        
        // Masquer la zone d'upload et afficher le fichier sélectionné
        uploadZone.style.display = 'none';
        fileSelected.classList.remove('d-none');
    }
});
</script>
{% endblock %}
